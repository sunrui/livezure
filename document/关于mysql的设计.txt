2012_12_6 rui.sun 18:34

过于频繁的访问 mysql 肯定是不可取的。
但是一些数据必须要用 mysql。例如说保持心跳，在当前在线的用户列表。

初步设计可以这么做。

对于所有登陆上来的 session 都放在内存中。然后在登陆上的一刻写入至在线 sql 表中。
再就是心跳的机制了。用户和内存中的 session 保持心跳，如果一旦失去连接，则从在线表删除。
所有登陆的云端都会在5分钟检测一次当前服务器在线列表的状态。
（在线列表与助于提供接口给web端，以便于网页实时的查看在线用户和设备的状态。）

考虑：这个时候，假如服务器突然挂掉了，怎么办呢。
客户端肯定有提示是断开了。

每一个登陆的中心服务器都会临时生成一个 session 存储在在线的服务器中。
然后所有连接上的fd是和这个服务器的session绑定。

这个时候，服务器端在每5分钟会做一次清理，应该中心服务器不止有一个，拿fd校验肯定不现实。就拿客户端，每 2 分钟，同步一次最近的心跳信息到 sql 中。
如果服务器检测，整个 fd，已经有 5 分钟没有登陆过了，则判定他断线。并发给相关人员。




